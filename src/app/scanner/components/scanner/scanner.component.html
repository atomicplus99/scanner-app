<!-- Scanner Component Moderno y Responsive -->
<section class="w-full transition-all duration-500">
  <!-- Status Header -->
  <div *ngIf="isScanning()" class="mb-6">
    <div class="relative overflow-hidden rounded-3xl p-5 transition-all duration-500 shadow-lg"
         [class]="scannerError() ? 'bg-gradient-to-r from-rose-50/80 to-pink-50/80 dark:from-rose-900/20 dark:to-pink-900/20 border border-rose-200/60 dark:border-rose-800/40' : 'bg-gradient-to-r from-emerald-50/80 to-teal-50/80 dark:from-emerald-900/20 dark:to-teal-900/20 border border-emerald-200/60 dark:border-emerald-800/40'">
      
      <!-- Efecto de fondo animado suave -->
      <div class="absolute inset-0 opacity-30"
           [class]="scannerError() ? 'bg-gradient-to-r from-rose-100/40 to-pink-100/40 dark:from-rose-800/20 dark:to-pink-800/20 animate-pulse' : 'bg-gradient-to-r from-emerald-100/40 to-teal-100/40 dark:from-emerald-800/20 dark:to-teal-800/20 animate-pulse'"></div>
      
      <div class="relative flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="relative">
            <div class="w-4 h-4 rounded-full animate-pulse shadow-lg"
                 [class]="scannerError() ? 'bg-rose-400' : 'bg-emerald-400'"></div>
            <div class="absolute inset-0 w-4 h-4 rounded-full animate-ping opacity-60"
                 [class]="scannerError() ? 'bg-rose-300' : 'bg-emerald-300'"></div>
        </div>
        <div>
            <span class="text-sm font-semibold"
                  [class]="scannerError() ? 'text-rose-700 dark:text-rose-300' : 'text-emerald-700 dark:text-emerald-300'">
            {{ scannerStatus() }}
          </span>
            <p class="text-xs opacity-80"
               [class]="scannerError() ? 'text-rose-600 dark:text-rose-400' : 'text-emerald-600 dark:text-emerald-400'">
              {{ scannerError() ? 'Error de conexión' : 'Escaneando activamente' }}
            </p>
          </div>
        </div>
        
        <div *ngIf="videoWidth() && videoHeight()" class="flex items-center space-x-2 px-4 py-2 bg-white/70 dark:bg-gray-800/70 rounded-xl backdrop-blur-sm shadow-md border border-gray-200/50 dark:border-gray-700/50">
          <svg class="w-4 h-4 text-slate-600 dark:text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
          </svg>
          <span class="text-xs font-medium text-slate-700 dark:text-slate-300">{{ videoWidth() }}×{{ videoHeight() }}</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Selector de cámara -->
  <div *ngIf="availableCameras().length > 1" class="mb-6">
    <div class="relative bg-gradient-to-r from-slate-50/80 to-gray-50/80 dark:from-slate-800/60 dark:to-gray-800/60 backdrop-blur-sm rounded-3xl border border-slate-200/60 dark:border-slate-700/50 p-5 shadow-lg">
      <label class="flex items-center space-x-3 text-sm font-semibold text-slate-700 dark:text-slate-300 mb-4">
        <div class="w-9 h-9 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-xl flex items-center justify-center shadow-md">
          <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        </div>
        <span>Seleccionar cámara</span>
      </label>
      
      <div class="relative">
        <select
          [disabled]="isScanning()"
          (change)="onCameraChange($event)"
          class="w-full px-4 py-3 text-sm bg-white/90 dark:bg-slate-700/90 border border-slate-200/60 dark:border-slate-600/60 rounded-2xl focus:outline-none focus:ring-2 focus:ring-indigo-400/50 focus:border-transparent disabled:opacity-50 disabled:cursor-not-allowed appearance-none dark:text-slate-200 backdrop-blur-sm transition-all duration-300 hover:bg-white dark:hover:bg-slate-700 shadow-sm"
        >
          <option *ngFor="let camera of availableCameras()" [value]="camera.deviceId">
            {{ camera.label || 'Cámara ' + (camera.deviceId ? '#' + camera.deviceId.substr(0, 5) : '') }}
          </option>
        </select>
        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
          <svg class="w-4 h-4 text-slate-500 dark:text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Contenedor principal del escáner -->
  <div class="w-full">
    <div class="relative bg-gradient-to-br from-slate-50/80 to-gray-50/80 dark:from-slate-800/60 dark:to-gray-800/60 backdrop-blur-sm rounded-3xl border border-slate-200/60 dark:border-slate-700/50 overflow-hidden shadow-2xl">
      <!-- Área de video -->
      <div class="relative min-h-[300px] transition-all duration-500" 
           [class]="isFullscreen ? 'fixed inset-0 z-50 min-h-screen' : ''"
           #qrRegionElement>
        
        <!-- Fondo mejorado para pantalla completa -->
        <div *ngIf="isFullscreen" class="absolute inset-0 bg-gradient-to-br from-indigo-900 via-purple-900 to-teal-900">
          <!-- Efectos de partículas animadas -->
          <div class="absolute inset-0 overflow-hidden">
            <!-- Partículas flotantes grandes -->
            <div class="absolute top-1/4 left-1/4 w-32 h-32 bg-indigo-400/20 rounded-full blur-3xl animate-pulse"></div>
            <div class="absolute top-3/4 right-1/4 w-24 h-24 bg-purple-400/20 rounded-full blur-2xl animate-pulse" style="animation-delay: 1s"></div>
            <div class="absolute bottom-1/4 left-1/3 w-40 h-40 bg-teal-400/20 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s"></div>
            <div class="absolute top-1/2 right-1/3 w-28 h-28 bg-rose-400/20 rounded-full blur-2xl animate-pulse" style="animation-delay: 0.5s"></div>
            
            <!-- Líneas de luz animadas -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-indigo-300/50 to-transparent animate-pulse"></div>
            <div class="absolute bottom-0 right-0 w-full h-1 bg-gradient-to-l from-transparent via-purple-300/50 to-transparent animate-pulse" style="animation-delay: 1s"></div>
            <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-transparent via-teal-300/50 to-transparent animate-pulse" style="animation-delay: 0.5s"></div>
            <div class="absolute top-0 right-0 w-1 h-full bg-gradient-to-b from-transparent via-rose-300/50 to-transparent animate-pulse" style="animation-delay: 1.5s"></div>
            
            <!-- Efectos de ondas -->
            <div class="absolute inset-0 opacity-30">
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-96 h-96 border border-indigo-300/30 rounded-full animate-ping"></div>
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 border border-purple-300/30 rounded-full animate-ping" style="animation-delay: 0.5s"></div>
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 border border-teal-300/30 rounded-full animate-ping" style="animation-delay: 1s"></div>
            </div>
          </div>
          
          <!-- Overlay sutil -->
          <div class="absolute inset-0 bg-gradient-to-t from-black/10 via-transparent to-black/10"></div>
        </div>
        <video #videoElement 
               class="w-full h-auto object-cover transition-all duration-500 relative z-10"
               [class]="isFullscreen ? 'h-screen rounded-none shadow-2xl' : 'rounded-3xl min-h-[300px]'"
               playsinline
               autoplay
               muted
               style="background-color: #000; display: block;">
        </video>
        
        <!-- Overlay de vidrio esmerilado para pantalla completa -->
        <div *ngIf="isFullscreen" class="absolute inset-0 z-20 pointer-events-none">
          <div class="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-black/10 backdrop-blur-[0.5px]"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/10 via-transparent to-transparent"></div>
        </div>
        <canvas #canvasElement class="hidden"></canvas>
        
        <!-- Botón de pantalla completa -->
        <button 
          (click)="toggleFullscreen()"
          class="absolute top-4 right-4 z-30 p-3 rounded-xl backdrop-blur-sm shadow-lg border transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-400/50"
          [class]="isFullscreen ? 'bg-white/10 hover:bg-white/20 text-white border-white/20' : 'bg-slate-800/80 hover:bg-slate-700/90 text-white border-slate-600/50'"
          [title]="isFullscreen ? 'Salir de pantalla completa (ESC)' : 'Pantalla completa'">
          <svg *ngIf="!isFullscreen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
          </svg>
          <svg *ngIf="isFullscreen" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4.5M9 9H4.5M9 9L3.5 3.5M15 9v4.5M15 9h4.5M15 9l5.5-5.5M9 15v4.5M9 15H4.5M9 15l-5.5 5.5M15 15h4.5M15 15v4.5m0-4.5l5.5 5.5"/>
          </svg>
        </button>
        
        <!-- Overlay del escáner cuando está activo -->
        <div *ngIf="isScanning()" class="absolute inset-0 pointer-events-none z-10">
          <!-- Marco de escaneo mejorado -->
          <div class="absolute border-2 shadow-lg transition-all duration-500"
               [class]="isFullscreen ? 'inset-20 rounded-3xl border-white/80 shadow-2xl shadow-white/20' : 'inset-6 rounded-2xl border-white/70'">
            <!-- Esquinas animadas mejoradas -->
            <div class="absolute -top-2 -left-2 w-8 h-8 border-t-4 border-l-4 rounded-tl-2xl animate-pulse shadow-lg transition-all duration-500"
                 [class]="isFullscreen ? 'border-indigo-400 shadow-indigo-400/50' : 'border-indigo-300'"></div>
            <div class="absolute -top-2 -right-2 w-8 h-8 border-t-4 border-r-4 rounded-tr-2xl animate-pulse shadow-lg transition-all duration-500"
                 [class]="isFullscreen ? 'border-purple-400 shadow-purple-400/50' : 'border-indigo-300'"></div>
            <div class="absolute -bottom-2 -left-2 w-8 h-8 border-b-4 border-l-4 rounded-bl-2xl animate-pulse shadow-lg transition-all duration-500"
                 [class]="isFullscreen ? 'border-teal-400 shadow-teal-400/50' : 'border-indigo-300'"></div>
            <div class="absolute -bottom-2 -right-2 w-8 h-8 border-b-4 border-r-4 rounded-br-2xl animate-pulse shadow-lg transition-all duration-500"
                 [class]="isFullscreen ? 'border-rose-400 shadow-rose-400/50' : 'border-indigo-300'"></div>
            
            <!-- Línea de escaneo animada mejorada -->
            <div class="absolute inset-x-0 top-1/2 h-1 bg-gradient-to-r from-transparent to-transparent animate-pulse shadow-lg transition-all duration-500"
                 [class]="isFullscreen ? 'via-white/60 shadow-white/30' : 'via-indigo-300'"></div>
          </div>
          
          <!-- Partículas flotantes mejoradas -->
          <div class="absolute inset-0 opacity-30">
            <div class="absolute top-12 left-12 w-2 h-2 bg-indigo-300 rounded-full animate-ping shadow-lg"></div>
            <div class="absolute top-16 right-16 w-1.5 h-1.5 bg-purple-300 rounded-full animate-ping shadow-lg" style="animation-delay: 0.5s"></div>
            <div class="absolute bottom-20 left-20 w-1 h-1 bg-teal-300 rounded-full animate-ping shadow-lg" style="animation-delay: 1s"></div>
            <div class="absolute bottom-12 right-12 w-2.5 h-2.5 bg-slate-300 rounded-full animate-ping shadow-lg" style="animation-delay: 1.5s"></div>
            <div class="absolute top-1/2 left-8 w-1 h-1 bg-indigo-200 rounded-full animate-ping shadow-lg" style="animation-delay: 2s"></div>
            <div class="absolute top-1/3 right-8 w-1.5 h-1.5 bg-purple-200 rounded-full animate-ping shadow-lg" style="animation-delay: 2.5s"></div>
          </div>
        </div>
        
        <!-- Indicador de estado flotante mejorado -->
        <div *ngIf="isScanning()" class="absolute transition-all duration-500 z-30"
             [class]="isFullscreen ? 'top-8 left-8 right-8' : 'top-4 left-4 right-4'">
          <div class="backdrop-blur-md text-slate-100 px-4 py-3 rounded-2xl text-sm flex items-center space-x-3 shadow-xl border transition-all duration-500"
               [class]="isFullscreen ? 'px-6 py-4 text-base bg-white/10 border-white/20' : 'bg-slate-800/70 border-slate-600/30'">
            <div *ngIf="scannerError()" class="w-5 h-5 text-rose-400">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
            </div>
            <div *ngIf="!scannerError()" class="w-5 h-5 text-emerald-400">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            <span class="text-sm font-medium">{{ scannerError() || scannerStatus() }}</span>
            
            <!-- Instrucciones para pantalla completa -->
            <div *ngIf="isFullscreen" class="ml-auto flex items-center space-x-2 text-xs text-slate-400">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM9 7H4l5-5v5z"/>
              </svg>
              <span>Presiona ESC para salir</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Panel de error mejorado -->
      <div *ngIf="scannerError()" class="p-6 bg-gradient-to-r from-red-50/80 to-pink-50/80 dark:from-red-900/20 dark:to-pink-900/20 border-t border-red-200/50 dark:border-red-800/50 backdrop-blur-sm">
        <div class="flex items-start space-x-4">
          <div class="w-8 h-8 bg-red-500/20 rounded-xl flex items-center justify-center mt-1">
            <svg class="w-5 h-5 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12" y2="16"></line>
            </svg>
          </div>
          <div class="flex-1">
            <div class="text-sm font-semibold text-red-800 dark:text-red-200 mb-1">Error del escáner</div>
            <div class="text-xs text-red-600 dark:text-red-300 mb-4">{{ scannerStatus() }}</div>
            
            <!-- Botón para reintentar mejorado -->
            <button 
              (click)="retryInitialization()"
              class="inline-flex items-center space-x-2 px-4 py-2 text-sm font-medium text-red-700 dark:text-red-300 bg-red-100/80 dark:bg-red-800/30 border border-red-300/50 dark:border-red-700/50 rounded-xl hover:bg-red-200/80 dark:hover:bg-red-800/50 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-red-500/50 focus:ring-offset-2 backdrop-blur-sm shadow-lg hover:shadow-xl transform hover:scale-105">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M23 4v6h-6"></path>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              <span>Reintentar</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Controles del escáner -->
  <div class="w-full space-y-4 mt-6">
    <!-- Botón principal mejorado -->
    <button
      (click)="toggleScanner()"
      class="w-full flex items-center justify-center space-x-4 px-8 py-5 rounded-2xl font-semibold text-white transition-all duration-500 shadow-2xl hover:shadow-3xl transform hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-offset-2 dark:focus:ring-offset-gray-900 backdrop-blur-sm"
      [class]="isScanning() ? 'bg-gradient-to-r from-red-500 via-pink-500 to-red-600 hover:from-red-600 hover:via-pink-600 hover:to-red-700 focus:ring-red-300/50' : 'bg-gradient-to-r from-blue-500 via-purple-500 to-indigo-600 hover:from-blue-600 hover:via-purple-600 hover:to-indigo-700 focus:ring-blue-300/50'"
    >
      <div class="w-6 h-6">
        <svg *ngIf="!isScanning()" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polygon points="5 3 19 12 5 21 5 3"></polygon>
        </svg>
        <svg *ngIf="isScanning()" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <rect x="6" y="4" width="4" height="16"></rect>
          <rect x="14" y="4" width="4" height="16"></rect>
        </svg>
      </div>
      <span class="text-lg">{{ isScanning() ? 'Detener escáner' : 'Iniciar escáner' }}</span>
    </button>
    
    <!-- Botón de linterna mejorado -->
    <button
      *ngIf="hasTorch()"
      [disabled]="!isScanning()"
      (click)="toggleTorch()"
      class="w-full flex items-center justify-center space-x-3 px-6 py-4 rounded-2xl font-medium transition-all duration-500 border-2 focus:outline-none focus:ring-4 focus:ring-offset-2 dark:focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed backdrop-blur-sm shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
      [class]="torchEnabled() ? 'bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border-yellow-300/50 dark:border-yellow-700/50 text-yellow-700 dark:text-yellow-300 hover:from-yellow-100 hover:to-orange-100 dark:hover:from-yellow-900/30 dark:hover:to-orange-900/30 focus:ring-yellow-300/50' : 'bg-white/60 dark:bg-gray-800/60 border-gray-300/50 dark:border-gray-600/50 text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-gray-800/80 focus:ring-gray-300/50'"
    >
      <div class="w-5 h-5">
        <svg *ngIf="!torchEnabled()" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M15 14l-4-4M16 4l4 4M12 2v3M2 12h3M4 20l4-4M20 4l-4 4M19 12h3M12 19v3M8 8l-4 4"></path>
        </svg>
        <svg *ngIf="torchEnabled()" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </div>
      <span class="text-base">{{ torchEnabled() ? 'Apagar linterna' : 'Encender linterna' }}</span>
    </button>
  </div>
  
  <!-- Indicador cuando no está escaneando -->
  <div *ngIf="!isScanning()" class="w-full mt-8">
    <div class="text-center p-8 bg-white/60 dark:bg-gray-800/60 backdrop-blur-sm rounded-3xl shadow-2xl border border-white/20 dark:border-gray-700/50">
      <div class="relative w-20 h-20 bg-gradient-to-br from-green-400 via-emerald-500 to-teal-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse shadow-xl">
        <div class="absolute inset-0 bg-gradient-to-br from-green-400/50 to-emerald-500/50 rounded-full animate-ping"></div>
        <svg class="w-10 h-10 text-white relative z-10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
      <div class="text-xl font-bold text-gray-900 dark:text-white mb-3">Escáner listo</div>
      <div class="text-sm text-gray-600 dark:text-gray-400 max-w-sm mx-auto">Presiona "Iniciar escáner" para comenzar a registrar la asistencia de los estudiantes</div>
      
      <!-- Indicador de estado -->
      <div class="mt-6 flex items-center justify-center space-x-2">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-xs text-gray-500 dark:text-gray-400">Sistema preparado</span>
      </div>
    </div>
  </div>
</section>